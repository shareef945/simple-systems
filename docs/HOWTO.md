## Simple Systems — How to run and troubleshoot

Overview

- **Purpose:** Run the Simple Systems API locally or in production, migrate the database, and perform Notion OAuth flows.

Prerequisites

- **Node & pnpm:** Node 22+, `pnpm` (corepack enabled). Install dependencies with `pnpm install`.
- **Docker:** Docker and Docker Compose (if using local Postgres or containers).
- **Notion app:** A Notion OAuth app with `client_id` and `client_secret` and an authorized redirect URL.

Important files

- **Env examples:** [/.env.example](../.env.example)
- **App env:** [/.env](../.env)
- **Docker compose:** [/docker-compose.yml](../docker-compose.yml)
- **Prisma schema:** [/prisma/schema.prisma](../prisma/schema.prisma)

Environment variables (minimum)

- **DATABASE_URL:** Postgres connection string used by Prisma (can point to Supabase cloud or local DB).
- **DIRECT_URL:** direct Postgres connection (Prisma `directUrl`) — CI requires this for schema validation.
- **NOTION_CLIENT_ID** / **NOTION_CLIENT_SECRET:** Notion OAuth credentials.
- **NOTION_REDIRECT_URI:** The callback your server exposes (NOT the full Notion authorize URL). Examples:
  - Local dev: `http://localhost:3000/notion/oauth/callback`
  - Production: `https://api.simplesystem.app/notion/oauth/callback`
- **TOKEN_ENC_KEY**, **OAUTH_STATE_SECRET**, **ADMIN_API_KEY**, etc. See `./.env.example` for full list.

Local development (quick)

1. Copy env example and edit values:

```bash
cp .env.example .env
# edit .env -> set DATABASE_URL/DIRECT_URL/NOTION_* and secrets
```

2. Install and generate Prisma client:

```bash
pnpm install
pnpm prisma:generate
```

3. Run migrations locally (dev):

```bash
pnpm prisma:migrate
```

4. Start the app locally:

```bash
pnpm start:dev
```

Using Docker Compose (local Postgres)

- The repo includes a `supabase-db` service in `docker-compose.yml`. If you prefer cloud DB, you can disable or remove that service.
- If you want the local DB to be opt-in, run only when needed (example if `profiles` set):

```bash
docker compose --profile local up --build
```

- To run only the `api` service and skip local db:

```bash
MIGRATE_ON_START=false docker compose up --no-build api
```

Notes about migrations in Docker

- The `Dockerfile` runs migrations by default only when `MIGRATE_ON_START=true`. If migrations point at your cloud DB and you don't want them auto-run, set `MIGRATE_ON_START=false` when starting the container.

Notion OAuth flow (how it works)

1. Your app endpoint `/notion/oauth/start?clientSlug=<slug>` is the canonical way to begin the flow.
   - The server generates a signed `state`, builds a Notion authorize URL with `redirect_uri` set to `NOTION_REDIRECT_URI` and includes `state`.
2. The user authorizes in Notion and Notion redirects back to `NOTION_REDIRECT_URI` (your `/notion/oauth/callback`) with `code` and `state`.
3. The server validates the `state` and exchanges `code` for an access token.

Important: DO NOT hand out or click a raw Notion authorize URL that lacks a `state` generated by your server — that will return an empty `state` and the callback will be rejected with "Invalid state format".

Troubleshooting

- If callback returns 401 "Invalid state format":
  - Ensure the OAuth flow was started via `/notion/oauth/start?clientSlug=...` (server-generated `state`).
  - Check that `Location:` header from `/notion/oauth/start` contains a non-empty `state`.
  - If `start` includes `state` but callback doesn't, inspect CDN/proxy (Cloudflare) rules for query param stripping or redirects.
- If Prisma CLI errors about `DIRECT_URL` in CI: make sure `DIRECT_URL` is set in the CI job env (we add it to `.github/workflows/ci-cd.yml`).
- If migrations appear to hang in Docker: set `MIGRATE_ON_START=false` and run `pnpm prisma migrate deploy` manually inside the container to see verbose output.
  ```bash
  docker compose run --rm api sh
  pnpm prisma migrate deploy
  ```

CI notes

- The `test` job runs a local Postgres service; ensure its env includes both `DATABASE_URL` and `DIRECT_URL` as shown in `.github/workflows/ci-cd.yml`.

Other tips

- Keep production secrets (DB connection, Notion secret, token keys) in your deployment environment or GitHub secrets, not committed to the repo.
- Prisma migrations live in `/prisma/migrations` — run `pnpm prisma:migrate` during development and `pnpm prisma:migrate deploy` in production Docker image if desired.

Where to look next in the code

- Notion start & callback controllers: [src/notion-oauth.controller.ts](../src/notion-oauth.controller.ts)
- Notion OAuth implementation: [src/notion-oauth.service.ts](../src/notion-oauth.service.ts)
- Prisma service: [src/prisma.service.ts](../src/prisma.service.ts)

If you want, I can:

- Add example `docker-compose.override.yml` for local development, or
- Add a short checklist into `README.md` copying the essential steps from this doc.
